version: '2.1'
services:
  mysql:
    image: mysql:5.7.21
    environment:
      MYSQL_ROOT_PASSWORD: debezium
      MYSQL_DATABASE: debezium-sample
      MYSQL_USER: mysqluser
      MYSQL_PASSWORD: mysqlpw
    ports:
      - "3306:3306"
    volumes:
      - ./mysql/config:/etc/mysql/conf.d
      - ./data/mysql:/var/lib/mysql
      - ./mysql/init:/docker-entrypoint-initdb.d
  zookeeper:
    image: debezium/zookeeper:1.7
    ports:
      - 2181:2181
      - 2888:2888
      - 3888:3888
  kafka:
    image: debezium/kafka:1.7
    ports:
      - 9092:9092
    links:
      - zookeeper
    environment:
      ADVERTISED_HOST_NAME: ${DOCKER_HOST_IP}
      ZOOKEEPER_CONNECT: zookeeper:2181
  connect:
    image: debezium/connect:1.7
    ports:
      - 8083:8083
    links:
      - kafka
      - mysql
    environment:
      - BOOTSTRAP_SERVERS=kafka:9092
      - GROUP_ID=1
      - CONFIG_STORAGE_TOPIC=my_connect_configs
      - OFFSET_STORAGE_TOPIC=my_connect_offsets
      - STATUS_STORAGE_TOPIC=my_connect_statuses
networks:
  default:
    external:
      name: 2021_fall_network_default

# networkつくる
# docker create network 2021_fall_network_default


# topic一覧
# docker exec -it docker_kafka_1 /kafka/bin/kafka-topics.sh --list --zookeeper zookeeper:2181

# とあるtopicを見る
# docker exec -it docker_kafka_1 /kafka/bin/kafka-console-consumer.sh --bootstrap-server "kafka:9092" --property print.key=true --property fetch.min.bytes=1 --topic "dbhistory.debezium-sample" --from-beginning

# connector登録
#  curl -i -X POST -H "Accept:application/json" -H "Content-Type:application/json" localhost:8083/connectors/ -d '{ "name": "sample-music-connector", "config": { "connector.class": "io.debezium.connector.mysql.MySqlConnector", "tasks.max": "1", "database.hostname": "mysql", "database.port": "3306", "database.user": "debezium-sample", "database.password": "debezium-sample", "database.server.id": "223344", "database.server.name": "debezium-sample", "database.include.list": "debezium-sample", "database.history.kafka.bootstrap.servers": "kafka:9092", "database.history.kafka.topic": "dbhistory.debezium-sample" } }'
